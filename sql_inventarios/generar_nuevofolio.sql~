
--CREATE TYPE folio AS (foliotext text, idclavefolio int);

CREATE OR REPLACE FUNCTION generar_nuevofolio(IN nombredocumento text, IN id_sucursal int)
RETURNS text AS $$

DECLARE
  id_cliente int;
  clave_folio text;
  idclavefolio int;
  max_folio int;
  numeroactual int;
  numeroactualnuevo int;
  numerofinal int;
  foliotext text;
  --resultrecord folio;
  
BEGIN
  EXECUTE 'SELECT "ID_Cliente" FROM "Sucursal_Sistema" WHERE "ID" =' || id_sucursal INTO id_cliente;
  EXECUTE 'SELECT "ID", "ClaveFolio" FROM "Clave_Folio" WHERE "NombreDocumento" =''' || nombredocumento ||''' AND "Id_ClienteSistema" = ' || id_cliente INTO idclavefolio, clave_folio;
  EXECUTE 'SELECT MAX("ID") FROM "Numeracion_Folio" WHERE "Id_ClaveFolio" =' || idclavefolio ||' AND "Id_Sucursal_Sistema" = ' || id_sucursal INTO max_folio;
  EXECUTE 'SELECT "NumeroActual", "NumeroFinal" FROM "Numeracion_Folio" WHERE "ID" = '|| max_folio INTO numeroactual, numerofinal;
   
  IF numeroactual > numerofinal THEN
   RAISE EXCEPTION 'DB_ERROR_01 --> %', numeroactual;
  END IF;
  IF numeroactual = numerofinal THEN
   RAISE NOTICE 'DB_NOTICE_01 --> %', numeroactual;
  ELSE
   numeroactualnuevo := numeroactual + 1;
   EXECUTE 'UPDATE "Numeracion_Folio" SET "NumeroActual" = ' || numeroactualnuevo ||' WHERE "ID" = '|| max_folio;
  END IF;

  foliotext := clave_folio || '_' || id_sucursal || '_' || numeroactualnuevo;     
  RAISE info 'Folio generado %', foliotext;
  RETURN foliotext;

  END;

$$ LANGUAGE PLPGSQL;